version: '3'

services:
  tf:
    build: ./terraform
    command: sh
    stdin_open: true
    tty: true
    volumes:
      - ./build/lambda_ready_app:/lambda_ready_app
      - ./build/s3_ready_app:/s3_ready_app
      - ./terraform:/blog-infrastructure-terraform
    depends_on:
      - api
    environment:
      - "API_TARGET=api:3000"

  ui:
    image: swiftdeveloper/swift-blog-ui:0.2.0
    volumes:
      - ./build/s3_ready_app:/app/s3_ready_app
    ports:
      - 1337:1337
    environment:
      - "API_URL=https://api-for.doing.science"
    depends_on: 
      - db
      - mock_data_populator


  api:
    image: swiftdeveloper/swift-blog-api:latest
    volumes:
      - ~/.aws:/root/.aws/:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ./build/sam_local_ready_app:/sam_local_ready_app
      - ./build/lambda_ready_app:/lambda_ready_app
      - ./terraform/scripts/wait-for-it.sh:/usr/local/bin/wait-for-it.sh
    ports:
      - 3000:3000
    environment:
      - HOST_CODE_PATH=${PWD}/build/sam_local_ready_app
      - DB_HOST=host.docker.internal
      - ALLOWED_ORIGIN=*
    depends_on: 
      - db
      - mock_data_populator

  mock_data_populator:
    image: swiftdeveloper/swift-blog-api:express-latest
    command: /bin/sh -c "wait-for-it.sh db:8000 -- node dynamo-db-populator.js"
    volumes:
      - ~/.aws:/root/.aws/:ro
      - ./terraform/scripts/wait-for-it.sh:/usr/local/bin/wait-for-it.sh
    environment:
      - DB_HOST=db
    depends_on:
      - db
    links:
      - db
      
  db:
    image: cnadiminti/dynamodb-local:latest
    ports:
      - 8000:8000